---
title: 文件上传
date: {{ date }}
top: false
cover: false
password:
toc: true
mathjax: true
summary:
tags: 文件上传
categories: 文件上传
---

# 文件上传

## 上传检测流程

![sum_up](https://gitee.com/h1ler/blogimage/raw/master/img/20210425001426.png)

![image-20210420012816046](https://gitee.com/h1ler/blogimage/raw/master/img/20210420012816.png)

## 客户端检测绕过（JS）

- 如何判断是前端验证呢？

  - 抓包监听，如果上传文件的时候还没有抓取到数据包，但浏览器就提示文件类型不正确的话，那么多半就是前端校验了

- 通常解法：

  - 抓包

    - 由于是前端校验，因此可以将shell.png重命名为shell.png 上传抓包时再将文件名修改为shell.php即可绕过前端限制，成功上传webshell。
  - 禁用JS

  - 因为JS来校验文件后缀的原因，因此直接在浏览器上禁用JS即可。

  - 方法

    - firefox：按**F12**打开调试工具，再按**F1**打开设置选项![image-20210415224247926](https://gitee.com/h1ler/blogimage/raw/master/img/20210415224321.png)
      - chrome在审查元素状态下可以找到**Setting**选项，然后在Debugger选项下面勾选**Disable Javascript**即可![image-20210415224547644](https://gitee.com/h1ler/blogimage/raw/master/img/20210415224547.png)
  - 调试JS
    - 虽然这种解法没有必要，不过倒是学到了如何调试网页
    - firefox中F12打开开发者工具，在调试器中打开异常处暂停，修改js变量whitelist中的值即可<img src="https://gitee.com/h1ler/blogimage/raw/master/img/20210415231009.png" alt="image-20210415231009461"  />
      - firefox中只能听过控制台输入var=value的形式更改变量的值
      - chrome中可直接修改

## 服务端检测绕过（MIME）

- MIME检测原理

  服务端MIME类型检测是通过检查http包的Content-Type字段中的值来判断上传文件是否合法的。

- 常见的MIME类型

      text/plain（纯文本）
      text/html（HTML文档）
      text/javascript（js代码）
      application/xhtml+xml（XHTML文档）
      image/gif（GIF图像）
      image/jpeg（JPEG图像）
      image/png（PNG图像）
      video/mpeg（MPEG动画）
      application/octet-stream（二进制数据）
      application/pdf（PDF文档）

- 绕过方式：将content-type字段改为常见的image/jpg等即可成功上传

## 服务器检测绕过（目录路径检测）

### - 00截断

- 原理：PHP 内核是由 C 语言实现的，所以使用了 C 语言中的一些字符串处理函数。比如在连接字符串时候， 0 字节 (\x00) 将作为字符串结束符。所以在这个地方，攻击者只要在最后加入一个 0 字节，就能截断 file 变量之后的字符串

- 形成条件

  - php版本要小于5.3.4
  - magic_quotes_gpc off

- 在url中%00表示ascll码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束

  比如

  https://mp.csdn.net/upfiles/?filename=test.txt                                此时输出的是test.txt

  加上%00

  https://mp.csdn.net/upfiles/?filename=test.php%00.txt                   此时输出的是test.php

  就绕过了后缀限制，可以上传webshell了

- 0x开头表示16进制，0在十六进制中是00, 0x00就是%00解码成的16进制

- 当执行move_uploaded_file($FILE['tmp_name'],$Path)时遇到0x00会自动截断，所以真正写入的实际地址是upload/a.php

- 案例一：

  - 此处是个POST包，在目录路径处构造完整路径用%00进行截断可以绕过随机重命名，并自定义为php文件进行解析![image-20210421134423517](https://gitee.com/h1ler/blogimage/raw/master/img/20210421134423.png)
  - 自定义为a.php并添加%00进行截断![image-20210421134718342](https://gitee.com/h1ler/tuci/raw/master/null/20210421134718.png)此处截断需要将%00进行url编码才行![image-20210421134823317](https://gitee.com/h1ler/tuci/raw/master/null/20210421134823.png)编码后如图即可成功上传![image-20210421135058090](https://gitee.com/h1ler/tuci/raw/master/null/20210421135058.png)

- 案例二

  - 随便上传一个文件后，url产生变化，此处可知其目录路径在url上传输![image-20210421204028019](https://gitee.com/h1ler/tuci/raw/master/null/20210421204028.png)
  - 抓包如下![image-20210421203726553](https://gitee.com/h1ler/blogimage/raw/master/img/20210421203726.png)
  - 同理进行改包截断![image-20210421205207078](https://gitee.com/h1ler/blogimage/raw/master/img/20210421205207.png)

- 两个案例中用法不同

  - 案例一：POST包中%00不会被url解码，所有只能通过burp先行解码再传输，或者直接hex中修改为00进行截断
  - 案例二：%00在被url解码之后是空字符

## 服务端检测绕过（文件扩展名检测）

### - 黑名单检测 

- 名单列表绕过

  默认情况下Apache 把 phtml、pht、php、php3、php4、php5 解析为 PHP，Fuzz一下找出黑名单里没有后缀进行攻击，比如asa或cer之类

- 文件名大小写绕过(至今尝试还未成功)

  用AsP,pHp之类的文件名绕过黑名单检测

- 特殊文件名绕过

  比如把http包里的文件名改为test.asp. 或test.asp空格,这种命名方式在windows中是不被允许的，也就是利用windows系统特性，绕过验证后，会被windows自动去掉后面的点或空格，但Unix/Linux没有这个特性

- 0x00截断绕过

  据说在asp程序中遇到过，待学习

- .htaccess文件攻击

  - PHP  manual中提到![image-20210421211503751](https://gitee.com/h1ler/tuci/raw/master/null/20210421211503.png)
  - 如果PHP安全没有配置好的话，就可以通过move_uploaded_file来overwrite服务器中的.htaccess文件,以此达到任意定义解析名单的目的，例如将jpg文件解析为php文件

- 解析调用/漏洞绕过

- 常用一句话

  ```php
  GIF89a? <script language="php">eval($_REQUEST[shell])</script>
  ```

  

### - 白名单检测

- 0x00截断绕过
- 文件名长度绕过白名单
- 解析调用/漏洞绕过

## 服务端检测绕过（文件内容检测）

### - 文件幻数检测

- 主要时检测文件内容开始处的文件幻，比如图片类型的文件幻数如下

- 常见文件幻数

  ```
  jpg	FF D8 FF E0 00 10 4A 46 49 46
  GIF 47 49 46 38 39 61
  PNG 89 50 4E 47 0D 0A 1A 0A
  ```

  

### - 文件相关信息检测

### - 文件加载检测

#### -- 渲染/加载测试

- 绕过方式：代码注入（例如图片马）

  用winhex看数据可以分析出这类工具的原理是在不破坏文件本身的渲染情况下找一个空白区进行填充代码，一般会是图片的注释区，对于渲染测试基本上都能绕过，毕竟本省的文件结构是完整的

#### -- 二次渲染

- `imagecreatefrom` 系列渲染图片都可能被绕过，有些特殊的图马是可以逃避过渲染的

- 绕过方式：

  - GIF

    渲染前后的两张GIF，没有发生变化的数据库部分直接插入Webshell即可

    1. 准备一张GIF![16036176592096](https://gitee.com/h1ler/blogimage/raw/master/img/16036176592096.gif)

    2. 上传至目标网站上渲染一下再导出![image-20210503144505868](https://gitee.com/h1ler/blogimage/raw/master/img/20210503144509.png)

    3. 用010editor对比未变化区域插入webshell

       ![image-20210502154810504](https://gitee.com/h1ler/tuci/raw/master/null/20210502154810.png)

    4. 由于测试网站存在文件包含漏洞，则可直接文件包含来执行攻击语句![image-20210502162553895](https://gitee.com/h1ler/blogimage/raw/master/img/20210502162601.png)

  - PNG

    PNG没有GIF那么简单，需要将数据写入到PLTE数据块或者IDAT数据块

    - 首先准备一个PNG图片![img](https://gitee.com/h1ler/blogimage/raw/master/img/16036276956867.png)
    - 实现细节参考https://wooyun.x10sec.org/static/drops/tips-16034.html
    - 写入 PLTE 数据块并不是对所有的 PNG 图片都是可行的，实验证明只有索引图像才可以成功插入 payload，灰度和真彩色图像均以失败告终
    - 修改索引图像插入 PHP 代码的脚本项目地址为：[Github - poc_png.py](https://github.com/hxer/imagecreatefrom-/blob/master/png/poc/poc_png.py)
    - 因为值有索引图像的 PNG 才可能插入 PLTE 数据块，但是我们上面准备的 PNG 并不符合要求，得需要在 PS 里面将图片模式修改为索引颜色：

  - JPG

    JPG也需要使用脚本将数据插入到特定的数据库，而且可能会不成功，所以需要多次尝试

## 解析攻击

### - 网络渗透的本质

### - 直接解析

### - 本地文件包含解析

### - .htaccess文件上传解析漏洞

- htaccess文件是[Apache](https://baike.baidu.com/item/Apache)服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页[301重定向](https://baike.baidu.com/item/301重定向)、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能

- 形成条件

  - apache服务器
  - 能够上传.htaccess文件，一般为**黑名单**限制
  - AllowOverride All，默认配置为关闭None
  - LoadModule rewrite_module modules/mod_rewrite.so #模块为开启状态
  - 上传目录具有可执行权限

- .htaccess写法

  ```
  SetHandler application/x-httpd-php
  ```

  当前目录所有文件均会被解析为php文件

  ```
  <FilesMatch "1">
  SetHandler application/x-httpd-php
  </FilesMatch>
  ```

  将文件名**包含**1的文件解析为php文件，可用作留后门，123.png 就会被解析成php

  ```
  AddType application/x-httpd-php .png
  ```

  将.png解析为php文件

### - web应用程序解析漏洞及其原理

## 上传攻击框架

### - 轻量级检测绕过攻击

### - 路径/扩展名检测绕过攻击

### - 文件内容性检测绕过攻击

### - 上传攻击框架

## 代码逻辑

### - 条件竞争

------

> 参考
>
> - [国光的文件上传靶场知识总结](https://www.sqlsec.com/2020/10/upload.html)
> - [上传攻击总结](https://wenku.baidu.com/link?url=vMCO-E0_utuzonHcMnZ-xlRIW2M3Sn0sarHUKHIqQawrl2juefZOfJmFhdUCRah8EpO1NEUxJk7hm2lcpvz-apwev02IT-IWlKmDRzIid7u)